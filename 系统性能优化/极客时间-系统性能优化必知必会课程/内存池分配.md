
或许有同学会认为，我又不写底层框架，内存分配也依赖虚拟机，并不需要应用开发者了解
。如果你也这么认为，我们不妨看看这个例子：在 Linux 系统中，
用 Xmx 设置 JVM 的最大堆内存为 8GB，但在近百个并发线程下，
观察到 Java 进程占用了 14GB 的内存。为什么会这样呢？

这是因为，绝大部分高级语言都是用 C 语言编写的，包括 Java，申请内存必须经过 C 库，
而 C 库通过预分配更大的空间作为内存池，来加快后续申请内存的速度。
这样，预分配的 6GB 的 C 库内存池就与 JVM 中预分配的 8G 内存池叠加在一起，
造成了 Java 进程的内存占用超出了预期。


掌握内存池的特性，既可以避免写程序时内存占用过大，
导致服务器性能下降或者进程 OOM（Out Of Memory，内存溢出）被系统杀死，
还可以加快内存分配的速度。在系统空闲时申请内存花费不了多少时间，
但是对于分布式环境下繁忙的多线程服务，获取内存的时间会上升几十倍。

另一方面，内存池是非常底层的技术，当我们理解它后，可以更换适合应用场景的内存池。
在多种编程语言共存的分布式系统中，内存池有很广泛的应用，
优化内存池带来的任何微小的性能提升，都将被分布式集群巨大的主机规模放大，
从而带来整体上非常可观的收益。

## 隐藏的内存池
### 内存申请顺序
当代码申请内存时，首先会到达应用层内存池，如果应用层内存池有足够的可用内存，
就会直接返回给业务代码，否则，它会向更底层的 C 库内存池申请内存。
比如，如果你在 Apache、Nginx 等服务之上做模块开发，这些服务中就有独立的内存池。
当然，Java 中也有内存池，当通过启动参数 Xmx 指定 JVM 的堆内存为 8GB 时，
就设定了 JVM 堆内存池的大小。

[内存池模型](https://static001.geekbang.org/resource/image/89/6a/893edd82d03c628fae83b95bd4fbba6a.jpg)

你可能听说过 Google 的 TCMalloc 和 FaceBook 的 JEMalloc，它们也是 C 库内存池。
当 C 库内存池无法满足内存申请时，才会向操作系统内核申请分配内存。

### 问题：Java 已经有了应用层内存池，为什么还会受到 C 库内存池的影响呢？
这是因为，除了 JVM 负责管理的堆内存外，Java 还拥有一些堆外内存，
由于它不使用 JVM 的垃圾回收机制，所以更稳定、持久，处理 IO 的速度也更快。
这些堆外内存就会由 C 库内存池负责分配，这是 Java 受到 C 库内存池影响的原因。

其实不只是 Java，几乎所有程序都在使用 C 库内存池分配出的内存。
C 库内存池影响着系统下依赖它的所有进程。

C 库内存池工作时，会预分配比你申请的字节数更大的空间作为内存池。
比如说，当主进程下申请 1 字节的内存时，Ptmalloc2 会预分配 132K 字节的内存
（Ptmalloc2 中叫 Main Arena），应用代码再申请内存时，
会从这已经申请到的 132KB 中继续分配
```bash
# cat /proc/2891/maps | grep heap
01643000-01664000 rw-p 00000000 00:00 0     [heap]
```
当我们释放这 1 字节时，Ptmalloc2 也不会把内存归还给操作系统。
Ptmalloc2 认为，与其把这 1 字节释放给操作系统，不如先缓存着放进内存池里，
仍然当作用户态内存留下来，进程再次申请 1 字节的内存时就可以直接复用，这样速度快了很多。

### 问题 你可能会想，132KB 不多呀？为什么这一讲开头提到的 Java 进程，会被分配了几个 GB 的内存池呢？
*多线程与单线程的预分配策略并不相同*
每个子线程预分配的内存是 64MB（Ptmalloc2 中被称为 Thread Arena，32 位系统下为 1MB，
64 位系统下为 64MB）。如果有 100 个线程，就将有 6GB 的内存都会被内存池占用。
当然，并不是设置了 1000 个线程，就会预分配 60GB 的内存，
子线程内存池最多只能到 8 倍的 CPU 核数，比如在 32 核的服务器上，
最多只会有 256 个子线程内存池，但这也非常夸张了，
16GB（64MB * 256 = 16GB）的内存将一直被 Ptmalloc2 占用。

### 多出来的内存池怎么优化呢
#### 1.可以调整 Ptmalloc2 的工作方式。
通过设置 MALLOC_ARENA_MAX 环境变量，可以限制线程内存池的最大数量，
当然，线程内存池的数量减少后，会影响 Ptmalloc2 分配内存的速度。
不过由于 Java 主要使用 JVM 内存池来管理对象，这点影响并不重要。

#### 2.可以更换掉 Ptmalloc2 内存池，选择一个预分配内存更少的内存池
比如 Google 的 TCMalloc。


## 选择 Ptmalloc2 还是 TCMalloc？
先来看 TCMalloc 适用的场景，它对多线程下小内存的分配特别友好。

# 资料
[alloc_address demo](https://github.com/russelltao/geektime_distrib_perf/tree/master/2-memory/alloc_address)

[Threade Arena](https://www.cnblogs.com/alisecurity/p/5486458.html)
[jvm疯狂吞占内存，罪魁祸首是谁？](https://www.jianshu.com/p/7350a95506f8)
使用系统命令pmap -x 3516查看进程的内存映射情况，会发现大量的64MB内存块存在；